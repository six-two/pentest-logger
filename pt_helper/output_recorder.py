import os
import shlex
import subprocess
from pt_helper import Command

SCRIPT_DIR = os.path.dirname(os.path.realpath(__file__))
REPLAY_SH = """
#!/bin/bash
# Replay the shell session recording that is in the same directory as this script
SCRIPT_DIR=$(dirname ${BASH_SOURCE[0]})
scriptreplay --log-out "${SCRIPT_DIR}/stdout" --log-timing "${SCRIPT_DIR}/stdout.time"
""".strip()

def create_replay_sh(output_dir: str) -> None:
    file_name = os.path.join(output_dir, "replay.sh")
    with open(file_name, "w") as f:
        f.write(REPLAY_SH)
    os.chmod(file_name, mode=0o755)

def create_pretty_run_command(cmd: Command) -> str:
    pretty_run = os.path.join(SCRIPT_DIR, "..", "pretty-run.py")
    pretty_run = os.path.realpath(pretty_run)

    command_string = shlex.join([cmd.name, *cmd.args])
    return shlex.join([pretty_run, command_string])

def run_with_script(cmd: Command, output_dir: str) -> int:
    create_replay_sh(output_dir)

    pretty_command_string = create_pretty_run_command(cmd)
    stdout_file = os.path.join(output_dir, "stdout")
    timing_file = os.path.join(output_dir, "stdout.time")

    return subprocess.call(
        [
            "script",
            "--return",
            "--quiet",
            "--log-out",
            stdout_file,
            "--log-timing",
            timing_file,
            "--command",
            pretty_command_string,
        ]
    )
